---
title: "RSY: MC1"
subtitle: "Studiengang Data Science (HS2022), FHNW"
author: "Jan Zwicky und Gabriel Torres"
date: "Letzte Aktualisierungen: `r format(Sys.time(), '%B %d, %Y')`"
output:
  bookdown::html_document2:
      code_folding: show
      toc: true
      toc_depth: 3
      toc_float: true
      number_sections: true
editor_options: 
  chunk_output_type: console
---
<style>
#TOC {
  background-color: #F5F5F5;
  font-size: 16px;
}
#header{
  color: #708090;
  background-color: #F5F5F5;
  font-size: 30px;
}
body{
  color: #708090;
  background-color:#F5F5F5;
}
</style>

# Aufgabenstellung


# Daten aufbereiten und Pakete Lesen
## Pakete Laden und Daten Einlesen
In diesem Abschnitt werden alle Pakete geladen.
```{r, message = FALSE, warning = FALSE}

# Pakete für Data wrangling und Visualisierung
library(tidyverse)
# Pakete für das HTML
library(bookdown)
library(knitr)
# Recommenderlab
library("recommenderlab")
```

```{r setup, cache=TRUE}
# Konfiguration der Pakete
knitr::opts_chunk$set(fit.align = 'left', cache = TRUE, warning = FALSE, message = FALSE)
```

```{r}
# Einlesen der CSV-Dateien
movies <- read.csv("ml-latest-small/movies.csv", sep = ",")
links <- read.csv("ml-latest-small/links.csv", sep = ",")
ratings <- read.csv("ml-latest-small/ratings.csv", sep = ",")
tags <- read.csv("ml-latest-small/tags.csv", sep = ",")
```

# EDA
## Welches sind die am häufigsten geschauten Filme?

```{r}
movie_ratings <- left_join(movies, ratings, "movieId")
movie_ratings %>%
  group_by(title,movieId,genres) %>%
  summarise(count = n()) %>%
  arrange(desc(count)) %>% 
  head()
```

## Welches sind die am häufigsten geschauten Genres?

```{r}
genres_sep <- movies %>%
  separate_rows(genres, sep = "[^-a-zA-Z0-9\\s]+", convert = FALSE) %>% 
  replace(. == '', 'no genres listed')
  
genres_sep %>%
  right_join(ratings, "movieId") %>% 
  group_by(genres) %>%
  summarise(count = n()) %>% 
  arrange(desc(count)) %>% 
  head()
```

## Wie verteilen sich die Kundenratings gesamthaft und nach Genres?

```{r}
# Gesamthaft
summary(ratings$rating)
hist(ratings$rating, main = "Total")

# Nach Genres
genres_sep_ratings <- genres_sep %>%
  right_join(ratings, "movieId")
ggplot(genres_sep_ratings, aes(x = rating, fill = genres)) + geom_bar(aes(y = ..prop.., group = 1)) + theme(legend.position="none") + facet_wrap(~ genres)
```

## Wie verteilen sich die mittleren Kundenratings pro Film?

```{r}
mean_rating_movie <- ratings%>%
  group_by(movieId)%>%
  summarise(mean_rating = mean(rating), count = n())

ggplot(mean_rating_movie, aes(mean_rating))+
  geom_density()+
  labs(title = "Verteilung der mittleren Kundenratings pro Film",
       x = "Durchschnittliche Bewertung",
       y = "Verteilung") +
  theme_classic()

ggplot(mean_rating_movie, aes(mean_rating, count, color = mean_rating)) +
  geom_point() +
  labs(title = "Verteilung der mittleren Kundenratings pro Film",
       x = "Durchschnittliche Bewertung",
       y = "Anzahl Bewertungen") +
  theme_classic() +
  scale_color_gradient(low="red", high="green")
```

## Wie stark streuen die Ratings von individuellen Kunden?

```{r}
set.seed(100)
sample_values = sample(1:610,4,replace = FALSE)

ratings %>%
  filter(userId %in% sample_values)%>%
ggplot(., aes(rating))+
  geom_density(aes(color = factor(userId)))+
  labs(title = "Streuung von Bewertungen von Kunden",
       subtitle = "random sample",
       x = "Bewertung",
       y = "Verteilung",
       color = "User ID") +
  theme_classic()
```

```{r}
sd_ratings <- ratings %>% 
  group_by(userId) %>% 
  summarise(SD = sd(rating), count = n())

ggplot(sd_ratings, aes(SD, count, color = count)) + geom_point() +
  labs(title = "Standardabweichung der Ratings pro User",
       x = "Standardabweichung",
       y = "Anzahl Ratings",
       color = "Anzahl Ratings") +
  theme_classic() +
  scale_color_gradient(low="green", high="black")
```

## Welchen Einfluss hat die Normierung der Ratings pro Kunde auf deren Verteilung?

```{r}
norm_ratings <- ratings %>% 
  group_by(userId) %>% 
  summarise(mean_rating = mean(rating), sd_rating = sd(rating)) %>% 
  full_join(., ratings, by = "userId")

norm_ratings$z_rating <- (norm_ratings$rating - norm_ratings$mean_rating) / 
  norm_ratings$sd_rating

ggplot(norm_ratings, aes(z_rating)) + geom_density() +
  labs(title = "Normierte Ratings",
       x = "Z-Normiertes Rating",
       y = "Verteilung") +
  theme_classic()

```

## Welche strukturellen Charakteristika (z.B.Sparsity) und Auffälligkeiten zeigt die User-Item Matrix?

```{r}
user_item <- norm_ratings %>%
  select(movieId, userId, z_rating)%>%
  pivot_wider(names_from = movieId, values_from = z_rating)

sum(is.na(user_item))/(dim(user_item)[1]*(dim(user_item)[2]))
```
Die User-Item Matrix ist zu 98.2 % Sparse.

